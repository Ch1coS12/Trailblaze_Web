<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Maps · Trailblaze</title>

  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto+Condensed:wght@700&display=swap"
    rel="stylesheet">

  <style>
    /* RESET */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* SMOOTH SCROLLING */
    html {
      scroll-behavior: smooth;
    }

    /* BODY */
    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, #4F695B 0%, #7f9e8e 100%);
      min-height: 100vh;
      color: #2f4f4f;
      overflow-x: hidden;
    }

    /* HEADER + NAVBAR */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: flex-start;
      padding: 10px 40px;
      z-index: 1000;
      background: transparent;
      transition: all 0.3s ease;
    }

    header.scrolled {
      background: transparent;
    }

    .logo img {
      height: 95px;
      width: auto;
      transition: all 0.3s ease;
    }

    nav {
      margin-left: auto;
      display: flex;
      gap: 30px;
      margin-top: 8px;
    }

    nav a {
      text-decoration: none;
      color: #EDE8DA;
      font-weight: bold;
      font-size: 16px;
      transition: all 0.3s ease;
      position: relative;
    }

    nav a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #EDE8DA;
      transition: width 0.3s ease;
    }

    nav a:hover::after,
    nav a.active::after {
      width: 100%;
    }

    nav a:hover,
    nav a.active {
      opacity: 0.8;
    }

    /* HERO SECTION */
    .hero-section {
      position: relative;
      width: 100%;
      height: 50vh;
      background: linear-gradient(135deg, #4F695B 0%, #7f9e8e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      overflow: hidden;
    }

    .hero-section::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(237,232,218,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
      }

      50% {
        transform: translateY(-20px) rotate(1deg);
      }
    }

    .hero-content {
      position: relative;
      z-index: 2;
      color: #EDE8DA;
      max-width: 800px;
      padding: 0 20px;
      animation: fadeInUp 1s ease-out;
    }

    .hero-content h1 {
      font-size: clamp(36px, 6vw, 48px);
      font-weight: 700;
      margin-bottom: 15px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .hero-subtitle {
      font-size: clamp(16px, 2.5vw, 20px);
      margin-bottom: 20px;
      opacity: 0.95;
      animation: fadeInUp 1s ease-out 0.2s both;
    }

    /* MAIN CONTENT */
    main {
      padding: 40px;
      display: flex;
      flex-direction: column;
      gap: 40px;
      background: rgba(237, 232, 218, 0.95);
      backdrop-filter: blur(20px);
      margin: 0 20px;
      border-radius: 25px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 10;
      animation: slideInUp 0.8s ease-out;
    }

    /* CONTENT ROW */
    .content-row {
      display: flex;
      gap: 30px;
      align-items: stretch;
    }

    /* MAP CONTAINER */
    .map-container {
      flex: 2 1 60%;
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.4s ease;
      position: relative;
    }

    .map-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(79, 105, 91, 0.1), transparent);
      transition: left 0.8s ease;
      z-index: 1;
    }

    .map-container:hover::before {
      left: 100%;
    }

    .map-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(79, 105, 91, 0.2);
    }

    #map-polygons {
      height: 60vh;
      width: 100%;
      position: relative;
      z-index: 2;
    }

    /* SIDEBAR */
    #sidebar {
      flex: 1 1 35%;
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: #4F695B;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
    }

    #sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(79, 105, 91, 0.05), transparent);
      transition: left 0.8s ease;
    }

    #sidebar:hover::before {
      left: 100%;
    }

    #sidebar:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(79, 105, 91, 0.15);
    }

    #sidebar h2 {
      margin: 0;
      font-family: 'Roboto Condensed', sans-serif;
      letter-spacing: 0.5px;
      font-size: 24px;
      color: #4F695B;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }

    #sidebar h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 50px;
      height: 3px;
      background: linear-gradient(135deg, #4F695B, #7f9e8e);
      border-radius: 2px;
    }

    #worksheet-select {
      padding: 12px 16px;
      font-size: 16px;
      font-family: inherit;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      color: #4F695B;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
    }

    #worksheet-select:focus {
      outline: none;
      border-color: #4F695B;
      box-shadow: 0 0 0 3px rgba(79, 105, 91, 0.1);
    }

    #worksheet-info {
      position: relative;
      z-index: 2;
    }

    #worksheet-info.hidden {
      display: none;
    }

    #worksheet-info h3 {
      color: #4F695B;
      margin-bottom: 15px;
      font-size: 18px;
    }

    #worksheet-info p {
      margin: 8px 0;
      line-height: 1.6;
      color: #2f4f4f;
      padding: 8px 0;
      border-bottom: 1px solid rgba(79, 105, 91, 0.1);
    }

    #worksheet-info p:last-child {
      border-bottom: none;
    }

    #worksheet-info strong {
      color: #4F695B;
      font-weight: 600;
    }

    /* HEATMAP SECTION */
    .heatmap-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
    }

    .heatmap-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(79, 105, 91, 0.05), transparent);
      transition: left 0.8s ease;
    }

    .heatmap-section:hover::before {
      left: 100%;
    }

    .heatmap-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(79, 105, 91, 0.15);
    }

    .heatmap-section h3 {
      color: #4F695B;
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 24px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }

    .heatmap-section h3::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 50px;
      height: 3px;
      background: linear-gradient(135deg, #4F695B, #7f9e8e);
      border-radius: 2px;
    }

    .heatmap-description {
      color: #7f9e8e;
      margin-bottom: 20px;
      line-height: 1.6;
      position: relative;
      z-index: 2;
    }

    #map-heat {
      height: 35vh;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      position: relative;
      z-index: 2;
    }

    /* INTRO SECTION */
    .intro-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .intro-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(79, 105, 91, 0.05), transparent);
      transition: left 0.8s ease;
    }

    .intro-section:hover::before {
      left: 100%;
    }

    .intro-section h2 {
      color: #4F695B;
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 28px;
      margin-bottom: 15px;
      position: relative;
      z-index: 2;
    }

    .intro-section p {
      color: #7f9e8e;
      font-size: 16px;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      position: relative;
      z-index: 2;
    }

    /* ANIMATIONS */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* RESPONSIVE */
    @media (max-width: 900px) {
      header {
        padding: 10px 20px;
      }

      nav {
        gap: 20px;
      }

      main {
        margin: 0 10px;
        padding: 20px;
      }

      .content-row {
        flex-direction: column;
      }

      #map-polygons {
        height: 50vh;
      }

      #map-heat {
        height: 30vh;
      }

      .hero-content h1 {
        font-size: 28px;
      }

      .hero-subtitle {
        font-size: 16px;
      }
    }

    @media (max-width: 600px) {
      nav {
        gap: 15px;
      }

      nav a {
        font-size: 14px;
      }

      #sidebar {
        padding: 20px;
      }

      .heatmap-section {
        padding: 20px;
      }

      .intro-section {
        padding: 20px;
      }
    }

    /* SCROLL ANIMATIONS */
    .scroll-reveal {
      opacity: 0;
      transform: translateY(50px);
      transition: all 0.8s ease;
    }

    .scroll-reveal.revealed {
      opacity: 1;
      transform: translateY(0);
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js"></script>
  <script>
    /* Loader oficial Google Maps JS API */
    (g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set(), e = new URLSearchParams(), u = () => h || (h = new Promise(async (f, n) => { a = m.createElement("script"); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps.__ib__"); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d.__ib__ = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a); })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : (d[l] = (f, ...n) => (r.add(f), u().then(() => d[l](f, ...n)))); })({ key: "REMOVED_GOOGLE_API_KEY", v: "weekly" });
  </script>
</head>

<body>
  <!-- HEADER -->
  <header id="header">
    <div class="logo">
      <img src="logo.png" alt="Trailblaze Logo" />
    </div>

    <nav>
      <a href="maps.html" class="active">Maps</a>
      <a href="aboutus.html">About&nbsp;Us</a>
      <a href="eventsweb.html">Events</a>
      <a href="login.html">Login</a>
    </nav>
  </header>

  <!-- HERO SECTION -->
  <section class="hero-section">
    <div class="hero-content">
      <h1>Explore Interactive Maps</h1>
      <p class="hero-subtitle">
        Discover territorial data through dynamic visualizations and detailed geographic insights
      </p>
    </div>
  </section>

  <main class="scroll-reveal">
    <!-- Introduction Section -->
    <section class="intro-section">
      <h2>Geographic Data Visualization</h2>
      <p>
        Our interactive mapping system provides comprehensive territorial analysis tools.
        Select a worksheet to explore detailed polygon data, or view the heatmap below
        to understand activity distribution across different regions. Each visualization
        offers unique insights into land management and territorial planning.
      </p>
    </section>

    <!-- Main Content Row -->
    <div class="content-row">
      <!-- Map Container -->
      <div class="map-container">
        <div id="map-polygons" aria-label="Interactive polygons map"></div>
      </div>

      <!-- Sidebar -->
      <aside id="sidebar">
        <h2>Worksheet Explorer</h2>
        <p style="color: #7f9e8e; margin-bottom: 15px; font-size: 14px;">
          Choose a worksheet to visualize its territorial boundaries and associated data on the map.
        </p>
        <select id="worksheet-select">
          <option value="">Select a worksheet...</option>
        </select>
        <div id="worksheet-info" class="hidden"></div>
      </aside>
    </div>

    <!-- Heatmap Section -->
    <section class="heatmap-section">
      <h3>Activity Heatmap</h3>
      <p class="heatmap-description">
        This heatmap visualization shows proximity to intervention zones across all worksheets.
        Warmer colors (red/orange) indicate areas closer to active intervention zones, while
        cooler colors (blue) represent areas farther from intervention activities. This helps
        identify territorial management priorities and operational focus areas.
      </p>
      <div id="map-heat" aria-label="Activity density heatmap"></div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', initMaps);

    // Header scroll effect
    const header = document.getElementById('header');
    window.addEventListener('scroll', function () {
      if (window.scrollY > 100) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    // Scroll reveal animation
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function (entries) {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('revealed');
        }
      });
    }, observerOptions);

    // Observe all scroll-reveal elements
    document.querySelectorAll('.scroll-reveal').forEach(el => {
      observer.observe(el);
    });

    let polyMap, heatMap;
    let polygonsDrawn = [], heatPolygons = [];
    let allWorksheets = [], heatmapLayer = null, heatmapData = [];

    async function initMaps() {
      const { Map, Polygon } = await google.maps.importLibrary('maps');
      const { LatLngBounds } = await google.maps.importLibrary('core');
      const { HeatmapLayer } = await google.maps.importLibrary('visualization');

      /* Map instances with enhanced styling */
      polyMap = new Map(document.getElementById('map-polygons'), {
        center: { lat: 38.7223, lng: -9.1393 }, zoom: 8,
        styles: [
          {
            featureType: 'all',
            elementType: 'geometry.fill',
            stylers: [{ color: '#f8f9fa' }]
          },
          {
            featureType: 'water',
            elementType: 'geometry.fill',
            stylers: [{ color: '#7f9e8e' }]
          },
          {
            featureType: 'landscape',
            elementType: 'geometry.fill',
            stylers: [{ color: '#EDE8DA' }]
          },
          {
            featureType: 'road',
            elementType: 'geometry.stroke',
            stylers: [{ color: '#4f695B' }]
          }
        ]
      });

      heatMap = new Map(document.getElementById('map-heat'), {
        center: { lat: 38.7223, lng: -9.1393 }, zoom: 8,
        disableDefaultUI: true, gestureHandling: 'greedy',
        styles: [
          {
            featureType: 'all',
            elementType: 'geometry.fill',
            stylers: [{ color: '#2f4f4f' }]
          },
          {
            featureType: 'water',
            elementType: 'geometry.fill',
            stylers: [{ color: '#4f695B' }]
          }
        ]
      });

      const select = document.getElementById('worksheet-select');
      const info = document.getElementById('worksheet-info');
      const BASE = '/rest';

      /* 1. Load worksheet list */
      try {
        const res = await fetch(`${BASE}/fo/search/generic`, { cache: 'no-store' });
        allWorksheets = await res.json();
        allWorksheets.forEach(ws => {
          const o = document.createElement('option');
          o.value = ws.id; o.textContent = `Worksheet #${ws.id} - ${ws.posa?.description || 'No description'}`;
          select.appendChild(o);
        });
      } catch (e) { console.error('Error loading worksheets:', e); }

      /* 2. Build heatmap data and polygons */
      await buildHeatmapDataAndPolygons(BASE, Polygon, LatLngBounds);

      heatmapLayer = new HeatmapLayer({
        map: heatMap, data: heatmapData,
        radius: 50, maxIntensity: 10, opacity: .7,
        gradient: [
          'rgba(0,0,255,0)',      // Transparent (no activity)
          'rgba(0,100,255,0.3)',  // Cold blue (far from intervention)
          'rgba(0,200,255,0.5)',  // Light blue
          'rgba(100,255,100,0.6)', // Green (moderate distance)
          'rgba(255,255,0,0.7)',  // Yellow (getting closer)
          'rgba(255,150,0,0.8)',  // Orange (close to intervention)
          'rgba(255,0,0,0.9)',    // Red (very close)
          'rgba(150,0,0,1)'       // Dark red (intervention zones)
        ]
      });

      if (heatmapData.length) {
        const hb = new LatLngBounds(); heatmapData.forEach(p => hb.extend(p)); heatMap.fitBounds(hb);
      }

      /* 3. Geolocation → choose nearest worksheet */
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
          const { latitude, longitude } = pos.coords;
          const nearestId = await findNearestWorksheet(latitude, longitude, BASE);
          if (nearestId) {
            select.value = nearestId;
            select.dispatchEvent(new Event('change'));
          }
        }, err => console.warn('Geolocation denied:', err));
      }

      /* 4. Manual selection */
      select.addEventListener('change', () => loadWorksheet(select.value, BASE, Polygon, LatLngBounds, info));
    }

    /* ---------- Heatmap: data + polygons ---------- */
    async function buildHeatmapDataAndPolygons(BASE, Polygon, LatLngBounds) {
      const { LatLng } = google.maps;
      heatmapData = []; heatPolygons = [];
      if (!proj4.defs['EPSG:3763']) {
        proj4.defs('EPSG:3763', '+proj=tmerc +lat_0=39.6682583333333 +lon_0=-8.13310833333333 +k=1 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs');
      }

      // First pass: collect all intervention zones (execution sheets)
      const interventionZones = [];
      try {
        const execSheetsRes = await fetch(`${BASE}/fe`, { cache: 'no-store' });
        if (execSheetsRes.ok) {
          const execSheets = await execSheetsRes.json();

          for (const sheet of execSheets) {
            if (sheet.state === 'IN_PROGRESS' || sheet.state === 'COMPLETED') {
              // Get worksheet details for this execution sheet
              try {
                const wsRes = await fetch(`${BASE}/fo/${sheet.associatedWorkSheetId}/detail`, { cache: 'no-store' });
                if (wsRes.ok) {
                  const wsDetail = await wsRes.json();
                  (wsDetail.parcels ?? []).forEach(p => {
                    const c = centroid(p.geometry);
                    if (c) interventionZones.push(c);
                  });
                }
              } catch (e) {
                console.warn('Error loading intervention zone:', e);
              }
            }
          }
        }
      } catch (e) {
        console.warn('Error loading execution sheets for heatmap:', e);
      }

      // Second pass: create heatmap data based on distance to intervention zones
      for (const ws of allWorksheets) {
        try {
          const r = await fetch(`${BASE}/fo/${ws.id}/detail`, { cache: 'no-store' });
          const det = await r.json();

          (det.parcels ?? []).forEach(p => {
            const c = centroid(p.geometry);
            if (c) {
              // Calculate minimum distance to any intervention zone
              let minDistance = Infinity;
              if (interventionZones.length > 0) {
                interventionZones.forEach(zone => {
                  const dist = haversine(c.lat, c.lng, zone.lat, zone.lng);
                  minDistance = Math.min(minDistance, dist);
                });
              } else {
                // If no intervention zones, use moderate distance
                minDistance = 50000; // 50km
              }

              // Convert distance to intensity (closer = higher intensity = warmer colors)
              // Max distance for calculation: 100km
              const maxDistance = 100000; // 100km
              const normalizedDistance = Math.min(minDistance / maxDistance, 1);
              const intensity = Math.max(1, (1 - normalizedDistance) * 10); // Invert: closer = higher intensity

              // Create weighted point for heatmap
              const point = new LatLng(c.lat, c.lng);
              point.weight = intensity;
              heatmapData.push(point);
            }

            /* draw polygon on heatMap with reduced opacity */
            drawGeom(heatMap, p.geometry, new LatLngBounds(), Polygon, heatPolygons, .15); // fillOpacity .15
          });
        } catch {/* ignore */ }
      }

      // Add intervention zones as high-intensity points
      interventionZones.forEach(zone => {
        const point = new LatLng(zone.lat, zone.lng);
        point.weight = 10; // Maximum intensity for intervention zones
        heatmapData.push(point);
      });
    }

    /* ---------- Auto-select nearest ---------- */
    async function findNearestWorksheet(lat, lng, BASE) {
      let nearest = null, minDist = Infinity;
      for (const ws of allWorksheets) {
        try {
          const r = await fetch(`${BASE}/fo/${ws.id}/detail`, { cache: 'no-store' }); if (!r.ok) continue;
          const d = await r.json();
          const c = centroid(d.parcels?.[0]?.geometry); if (!c) continue;
          const dist = haversine(lat, lng, c.lat, c.lng);
          if (dist < minDist) { minDist = dist; nearest = ws.id; }
        } catch {/* pass */ }
      }
      return nearest;
    }

    /* ---------- Load selected worksheet ---------- */
    async function loadWorksheet(id, BASE, Polygon, LatLngBounds, info) {
      clearPolygons();
      if (!id) { info.classList.add('hidden'); info.innerHTML = ''; return; }
      try {
        const r = await fetch(`${BASE}/fo/${id}/detail`, { cache: 'no-store' });
        const det = await r.json();
        const b = new LatLngBounds();
        (det.parcels ?? []).forEach(p => drawGeom(polyMap, p.geometry, b, Polygon, polygonsDrawn, .35));
        if (!b.isEmpty()) polyMap.fitBounds(b);

        info.innerHTML = `<h3>Worksheet #${id}</h3>
      <p><strong>POSP:</strong> ${det.posp?.description ?? '—'}</p>
      <p><strong>POSA:</strong> ${det.posa?.description ?? '—'}</p>
      <p><strong>Start Date:</strong> ${fmt(det.startingDate)}</p>
      <p><strong>End Date:</strong> ${fmt(det.finishingDate)}</p>
      <p><strong>Service Provider:</strong> ${det.serviceProviderId ?? '—'}</p>
      <p><strong>Total Parcels:</strong> ${det.parcels?.length || 0}</p>`;
        info.classList.remove('hidden');
      } catch (e) { console.error(e); }
    }

    /* ---------- helpers ---------- */
    function clearPolygons() { polygonsDrawn.forEach(p => p.setMap(null)); polygonsDrawn = []; }

    function drawGeom(map, g, bounds, Polygon, storeArray, fillOp = .35) {
      if (!g) return;
      if (typeof g === 'string') { try { g = JSON.parse(g); } catch { return; } }
      const conv = proj4('EPSG:3763', 'WGS84');
      const parts = g.type === 'Polygon' ? [g.coordinates] : g.coordinates;
      parts.forEach(r => {
        const path = r[0].map(([x, y]) => { const [lon, lat] = conv.forward([x, y]); const p = { lat, lng: lon }; bounds.extend(p); return p; });
        const poly = new Polygon({
          paths: path, map, strokeColor: '#4f695B', strokeOpacity: .9, strokeWeight: 2,
          fillColor: '#4f695B', fillOpacity: fillOp, zIndex: 3
        });
        storeArray?.push(poly);
      });
    }

    function centroid(g) {
      if (!g) return null;
      if (typeof g === 'string') { try { g = JSON.parse(g); } catch { return null; } }
      const conv = proj4('EPSG:3763', 'WGS84');
      const parts = g.type === 'Polygon' ? [g.coordinates] : g.coordinates;
      const ring = parts[0][0]; let sl = 0, sg = 0, c = 0;
      ring.forEach(([x, y]) => { const [lon, lat] = conv.forward([x, y]); sl += lat; sg += lon; c++; });
      return c ? { lat: sl / c, lng: sg / c } : null;
    }

    /* haversine simple */
    const rad = x => x * Math.PI / 180, R = 6371000;
    function haversine(lat1, lon1, lat2, lon2) {
      const φ1 = rad(lat1), φ2 = rad(lat2), dφ = rad(lat2 - lat1), dλ = rad(lon2 - lon1);
      const a = Math.sin(dφ / 2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(dλ / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
    const fmt = d => d ? new Date(d).toLocaleDateString('en-US') : '—';

    // Add loading animation for page
    window.addEventListener('load', function () {
      document.body.style.opacity = '0';
      setTimeout(() => {
        document.body.style.transition = 'opacity 1s ease-in-out';
        document.body.style.opacity = '1';
      }, 100);
    });
  </script>
</body>

</html>